pipeline {
    agent any

    

    tools {
        maven 'Maven-3.9.1'
    }

    stages { 

        
     
         

        stage('maven build and test') {
            steps {
                sh 'ls -ltr'
                sh "mvn clean package -DskipTests=true "
                sh "mvn compile"
            }
        }
       stage('snyk scan') {
            steps {
                withCredentials([string(credentialsId: 'SNYK_API_TOKEN', variable: 'SNYK_API_TOKEN')]) {
                 sh 'mvn snyk:test -fn'     }              
            }
        }
      
       stage('sonarcloud scan') {
            steps {
               script{ withCredentials([string(credentialsId: 'SONARCLOUD_TOKEN', variable: 'SONARCLOUD_TOKEN')]) {
                        sh'mvn clean verify sonar:sonar \
                              -Dsonar.token=SONARCLOUD_TOKEN \
                               -Dsonar.host.url=https://sonarcloud.io \
                               -Dsonar.organization=deepak4566 \
                               -Dsonar.projectKey=deepak4566_spring-petclinic -fn '
                      }  }            
            }
        }

       stage('building a docker image and push image ') {
         steps{
           script {
             sh "docker build -t deepak8934/petapp:${BUILD_NUMBER} ."
             sh " docker push  deepak8934/petapp:${BUILD_NUMBER}"
                
        }
          
      }
    } 
 
      
        
    }
}
