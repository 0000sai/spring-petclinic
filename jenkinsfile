pipeline {
    agent any

    stages {
        stage('snyk scan') {
            steps {
                snykSecurity(
                    snykInstallation: 'snyk@latest',
                    snykTokenId: 'snyk_api_token',
                    monitorProjectOnBuild: false,
                    failOnIssues: false,  // Use boolean for failOnIssues
                    additionalArguments: '--json-file-output=all-vulnerabilities.json'
                )
            }
        }

        stage('maven build artifact') {
            steps {
                sh 'mvn clean package -DskipTests=true -Dcheckstyle.skip -fn'  // Correct capitalization for -DskipTests
            }
        }

       stage('TRIVY FS SCAN') {
            steps {
                sh "trivy fs . > trivyfs.txt"
            }
        }

        stage('building a docker image') {
            steps {
                sh "docker build -t deepak8934/petapp:${BUILD_NUMBER} ."
            }
        }

       stage("TRIVY"){
            steps{
                sh "trivy image  deepak8934/petapp:${BUILD_NUMBER} --ignore-unfixed > trivyimage.txt" 
            }
        }

        stage('docker image push') {
            steps {
                withDockerRegistry(credentialsId: 'dockercred', url: '') {
                    sh "docker push deepak8934/petapp:${BUILD_NUMBER}"
                }
            }
        }

        
    }
}
